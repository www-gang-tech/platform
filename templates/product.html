<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'none'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' https: data:; font-src 'self'; connect-src 'self' http://localhost:8000; base-uri 'self'; form-action 'self' https:;">
    
    <title>{{ title }} - {{ site_title }}</title>
    <meta name="description" content="{{ description }}">
    <link rel="canonical" href="{{ canonical_url }}">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="product">
    <meta property="og:title" content="{{ title }}">
    <meta property="og:description" content="{{ description }}">
    <meta property="og:url" content="{{ canonical_url }}">
    {% if product_image %}
    <meta property="og:image" content="{{ product_image }}">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    {% endif %}
    <meta property="product:price:amount" content="{{ price }}">
    <meta property="product:price:currency" content="{{ currency }}">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{{ title }}">
    <meta name="twitter:description" content="{{ description }}">
    {% if product_image %}
    <meta name="twitter:image" content="{{ product_image }}">
    {% endif %}
    
    <!-- JSON-LD Product Schema -->
    {% if jsonld %}
    <script type="application/ld+json">
    {{ jsonld | tojson }}
    </script>
    {% endif %}
    
    <link rel="stylesheet" href="/assets/style.css">
</head>
<body>
    {% include "partials/header.html" %}
    
    <main>
        <div class="product-container">
            <div class="product-gallery">
                {% if product_images %}
                    {% if product_images is string %}
                        <!-- Fallback: product_images came as string, use product_image -->
                        <img src="{{ product_image }}" 
                             alt="{{ title }}" 
                             width="800" 
                             height="800" 
                             loading="eager" 
                             decoding="async">
                    {% else %}
                        {% for image in product_images %}
                        <img src="{{ image }}" 
                             alt="{{ title }}" 
                             width="800" 
                             height="800" 
                             loading="{{ 'eager' if loop.first else 'lazy' }}" 
                             decoding="async"
                             data-variant-image="{{ loop.index0 }}"
                             style="{{ 'display: block;' if loop.first else 'display: none;' }}">
                        {% endfor %}
                    {% endif %}
                {% endif %}
            </div>
            
            <div class="product-info">
                <h1>{{ title }}</h1>
                
                <div class="product-price" data-price>
                    {{ currency }} {{ price }}
                </div>
                
                <div class="product-description markdown-body">
                    {{ content | safe }}
                </div>
                
                <!-- Product Form (works without JS, enhanced with JS) -->
                <form class="product-form" 
                      action="#" 
                      method="GET"
                      data-product-name="{{ title }}"
                      data-price="{{ price }}"
                      data-currency="{{ currency }}"
                      data-image="{{ product_image }}"
                      data-product-url="/products/{{ title | lower | replace(' ', '-') }}/"
                      data-sku="{{ sku }}"
                      data-variant-id="{{ sku }}">
                    
                    {% if colors %}
                    <div class="form-group">
                        <label for="color">Color:</label>
                        <select name="color" id="color" required>
                            {% for color in colors %}
                            <option value="{{ color }}">{{ color }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}
                    
                    {% if sizes %}
                    <div class="form-group">
                        <label for="size">Size:</label>
                        <select name="size" id="size" required>
                            {% for size in sizes %}
                            <option value="{{ size }}">{{ size }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}
                    
                    <div class="form-group">
                        <label for="quantity">Quantity:</label>
                        <input type="number" name="quantity" id="quantity" value="1" min="1" max="99" required>
                    </div>
                    
                    <p data-stock-message style="margin: 1rem 0; font-weight: 500;">
                        {% if 'InStock' in availability %}✓ In Stock{% else %}✗ Out of Stock{% endif %}
                    </p>
                    
                    <button type="submit" class="buy-button">
                        Add to Cart
                    </button>
                </form>
                
                <!-- Variant data for JS (hidden) -->
                {% if variants %}
                <script type="application/json" id="variants-data">
                {{ variants | tojson }}
                </script>
                {% endif %}
                
                <div class="product-meta" style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--color-border);">
                    <dl style="display: grid; grid-template-columns: auto 1fr; gap: 0.5rem 1rem;">
                        {% if sku %}
                        <dt style="font-weight: 600;">SKU:</dt>
                        <dd>{{ sku }}</dd>
                        {% endif %}
                        
                        {% if brand %}
                        <dt style="font-weight: 600;">Brand:</dt>
                        <dd>{{ brand }}</dd>
                        {% endif %}
                        
                        {% if category %}
                        <dt style="font-weight: 600;">Category:</dt>
                        <dd>{{ category }}</dd>
                        {% endif %}
                    </dl>
                </div>
            </div>
        </div>
    </main>
    
    {% include "partials/footer.html" %}
    
    <!-- Progressive enhancement for variants (works without JS) -->
    <script src="/assets/cart.js" defer></script>
    {% if variants %}
    <script src="/assets/product.js" defer></script>
    {% endif %}
</body>
</html>
